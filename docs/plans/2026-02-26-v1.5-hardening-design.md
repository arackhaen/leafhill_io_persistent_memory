# v1.5.0 Hardening Release Design

**Date**: 2026-02-26
**Version**: 1.5.0
**Status**: Approved

## Understanding Summary

- **What**: Hardening release — input validation, removal of silent limits, comprehensive test coverage, and cleanup of misleading interfaces
- **Why**: Make the v1.4 feature set production-solid before adding new capabilities
- **Who**: For the project maintainer and any future users deploying the MCP server
- **Key constraints**: Rust 1.75 toolchain, existing SQLite schema must remain backwards-compatible (ALTER TABLE only), no new feature dependencies
- **Explicit non-goals**: No new features (MySQL, TLS, new MCP tools), no Rust version upgrade, no async refactoring

## Assumptions

1. Validation enums are the documented values: status=`{pending, in_progress, completed, blocked, deleted}`, priority=`{low, medium, high}`, task_type=`{claude, human, hybrid}`, entry_type=`{summary, raw_user, raw_assistant, pre_compact}`
2. Invalid values return clear errors (not silently coerced or ignored)
3. Existing data with invalid values (if any) is not retroactively fixed — validation applies to new writes only
4. Tests use in-memory SQLite (`:memory:`) for speed, no external dependencies
5. The "fix misleading interfaces" work (dead `--batch-size`, MySQL in help, README examples) is included as low-effort cleanup alongside the three main areas
6. Archive `--limit` defaults to unlimited (no cap), with a stderr warning when results exceed 100K rows

## Design

### 1. Validation Enums

New types in `db.rs` (or a new `types.rs` if db.rs grows too large):

```rust
pub enum TaskStatus { Pending, InProgress, Completed, Blocked, Deleted }
pub enum TaskPriority { Low, Medium, High }
pub enum TaskType { Claude, Human, Hybrid }
pub enum EntryType { Summary, RawUser, RawAssistant, PreCompact }
```

Each gets:
- `FromStr` — parses from the string forms used in JSON/CLI (e.g., `"in_progress"` → `InProgress`)
- `Display` — renders back to the canonical string form
- `Serialize`/`Deserialize` via serde `rename_all = "snake_case"`

**DB layer**: `create_task()`, `update_task()`, `log_conversation()` accept `&str` as today, but validate by parsing into the enum before executing SQL. Returns a new `ValidationError` variant on failure.

**MCP layer**: `mcp.rs` tool handlers parse enum fields from the JSON params early, returning a clear MCP error like `"Invalid status 'oops'. Must be one of: pending, in_progress, completed, blocked, deleted"`.

**CLI layer**: clap's `ValueEnum` derive on the enums gives automatic validation and help text for free on CLI args that use these types. For the `--status` flag in `task update`, clap rejects invalid values before our code runs.

**Backwards compatibility**: Existing data with hypothetical invalid values stays untouched. Validation applies only to new writes.

### 2. Archive Limit Changes

**CLI**: Add `--limit <N>` flag to `archive create` in `cli.rs`. Type `Option<usize>`, default `None` (unlimited).

**DB layer**: The three query methods — `query_memories_for_archive()`, `query_conversations_for_archive()`, `query_tasks_for_archive()` — currently hardcode `LIMIT 100000`. Change signature to accept `limit: Option<usize>`. When `None`, no LIMIT clause. When `Some(n)`, use that value.

**Warning**: After collecting results in `run_archive_create()`, if total entity count >= 100,000, print to stderr:
```
Warning: archive contains 142,381 entities. Consider using --limit to reduce size.
```

This is a stderr warning only — it does not block the archive.

No changes to `archive restore` — it processes whatever is in the file.

### 3. Cleanup Items

**Dead `--batch-size` flag**: Remove the flag from CLI and the `_batch_size` parameter from `run_export()`. The current row-by-row approach works fine at medium scale. If batching is needed later, add it back with a real implementation.

**MySQL in help text**: Change `cli.rs` Export command doc comment from `"Export data to an external RDBMS (PostgreSQL, MySQL)"` to `"Export data to PostgreSQL"`. The error message in `rdbms_export.rs` already explains MySQL is deferred — that stays.

**README CLI examples**: Fix the two incorrect examples:
- `leafhill-persistent-memory memory list` → actual command is `leafhill-persistent-memory list`
- `link list --type task --id 42` → actual command is `leafhill-persistent-memory link list task 42`

**Missing FTS update trigger**: Add `conversations_au` trigger for conversations FTS to match the pattern used for memories. Prevents a latent bug if conversation updates are added later.

### 4. Test Infrastructure & Coverage

**Structure**: Unit tests as `#[cfg(test)] mod tests` inside each source file. Integration tests in a `tests/` directory at the project root.

**Test database**: All tests use in-memory SQLite via `Database::open_in_memory()` — a new convenience method that calls `Connection::open_in_memory()` + `init_db()`. No temp files, no cleanup, fast.

**Unit tests by file:**

**db.rs** (~20 tests):
- `init_db` creates all tables and FTS indexes
- `init_db` migration is idempotent (call twice, no error)
- Memory CRUD: store, upsert, search, list, delete
- Conversation: log, search, list, get_context, prune
- Task CRUD: create, update, get, list, search, delete (soft)
- Task deps: add, get, remove
- Links: create, get, delete
- PreCompact batch insert: stores messages, returns count
- Validation: reject invalid status, priority, task_type, entry_type with clear errors

**hook.rs** (~8 tests):
- `extract_content`: string content → as-is
- `extract_content`: array with text+thinking → concatenated, tool_use skipped
- `extract_content`: array with tool_result → content extracted
- `extract_content`: empty/missing content → empty string
- `derive_session_id`: formats correctly
- `project_from_cwd`: extracts last path component, handles edge cases (trailing slash, empty)

**archive.rs** (~4 integration tests in `tests/`):
- Archive create → restore round-trip preserves all fields
- Archive with `--limit` caps results
- Archive `--purge` removes source data
- Warning emitted at 100K threshold (test threshold check logic in isolation)

**rdbms_export.rs**: Skip — requires a live PostgreSQL instance. Document as manual test only.

**mcp.rs** (~4 integration tests):
- Tool dispatch: valid tool name returns result
- Invalid enum params return structured MCP error
- Unknown tool returns error

**CLI** (~3 integration tests):
- Binary runs `--version` successfully
- Binary runs `--help` successfully
- Invalid subcommand returns non-zero exit

## Implementation Plan

**Phase 1: Test infrastructure + `open_in_memory()` + db.rs unit tests**
Establishes the foundation. Every subsequent phase writes tests alongside code. Catches any existing bugs in db.rs before modification.

**Phase 2: Validation enums + validation tests**
Add the enum types, wire into db.rs, mcp.rs, and cli.rs. Test at all three layers. Highest design impact — do it early while context is fresh.

**Phase 3: Archive limit + cleanup fixes**
Configurable `--limit`, 100K warning, remove dead `--batch-size`, fix help text, fix README examples, add FTS update trigger. All straightforward changes with tests.

**Phase 4: hook.rs tests + integration tests + version bump**
Complete the test suite. Integration tests for archive round-trip, MCP dispatch, CLI basics. Bump to 1.5.0 in all version-bearing files. Update README if needed.

## Decision Log

| # | Decision | Alternatives | Reason |
|---|----------|-------------|--------|
| 1 | Hardening release, no new features | New capabilities, mix | Solidify v1.4 before expanding |
| 2 | Validation at DB + caller layers | DB only, caller only | Best UX (context-specific errors) + safety (DB as backstop) |
| 3 | Rust enums with FromStr/Display | Const string checks, DB-only | Compile-time safety, natural clap/serde integration |
| 4 | Archive `--limit` flag, default unlimited | Remove limit, warn only | User control + backwards compatible |
| 5 | Warning at 100K rows (stderr) | Hard error, silent | Informative without blocking |
| 6 | Skip PostgreSQL TLS for v1.5 | native-tls, env flag | No real use case yet, avoids dependency churn |
| 7 | Remove dead `--batch-size` flag | Implement batching | Avoids false promises; add back when needed |
| 8 | In-memory SQLite for all tests | Temp files, shared test DB | Fast, no cleanup, isolated |
| 9 | Skip rdbms_export tests | Mock PostgreSQL | Requires live DB; manual test only |
| 10 | Unit tests in-file, integration in `tests/` | All in `tests/` | Rust convention, tests close to code |
